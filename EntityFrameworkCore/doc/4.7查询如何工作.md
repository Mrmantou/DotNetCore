#### 查询如何工作

EF Core使用LINQ从数据库查询数据。LINQ允许使用C#(或选择的其它.NET语言)编写基于派生context和实体类的强类型查询。

##### 查询生命周期

下面使每个查询所经历的过程的高级概述。

1. LINQ查询由EF Core处理，以构建一个可以被数据库提供程序处理的表示。
   1. 这个结果被缓存下来，以便这个过程不必在查询每次执行的时候重复的做
2. 结果传递给数据库提供程序
   1. 数据库提供程序辨别查询的哪些部分可以在数据库中计算
   2. 将数据库计算的部分转换为数据库特定的查询语言(例如，关系型数据库的SQL)
   3.一个或更多的查询发送到数据库并返回结果集(结果是数据库中的值，不是实体实例)
3. 对结果集中的每个项
   1. 如果是跟踪查询，EF检查数据表示的实体是否已经存在于context实例的变更跟踪器
      1. 如果存在，返回存在的实体
	  2. 如果不存在，创建一个新实体，设置变更跟踪，然后返回新实体
   2. 如果是非跟踪查询，EF检查数据表示的实体是否已经存在于这个查询的返回集
      1. 如果存在，返回存在的实体
	  2. 如果不存在，创建一个新实体并返回

非跟踪查询使用弱引用来跟踪已返回的实体。如果具有相同标识的前一个结果超出范围，并运行垃圾收集，可能会得到一个新的实体实例。

##### 查询何时被执行

在调用LINQ操作时，只是简单在内存中构建查询的表示。查询只是在结果被使用时发送到数据库。

导致查询被发送到数据库的最常见操作是：
* 在`for`循环中遍历结果
* 使用类似于`ToList`, `ToArray`, `Single`, `Count`操作
* 绑定查询结果到UI

>**警告**
>
>**始终验证用户输入：** 虽然EF通过在查询中使用参数和转义文本来方式sql输入攻击，但是它并不校验输入。根据应用的要求，在LINQ查询中使用来自不受信任源的值、分配给实体属性或传递给其它EF Core API之前，应当执行适当的校验。这包含用于动态构建查询的任何用户输入。即使在使用LINQ时，如果接受用户数据来构建表达式，也需要确保只能构建预期的表达式。
